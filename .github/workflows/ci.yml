name: SQLite CI

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  sqlite-macos:
    runs-on: macos-latest
    env:
      VFLAGS: -no-retry-compilation
    steps:
      - name: Checkout V
        uses: actions/checkout@v4
        with:
          repository: vlang/v
      - name: Checkout the V SQLite module
        uses: actions/checkout@v4
        with:
          path: mysqlite
      - name: Build local v
        run: make && ./v symlink
      - name: Link local checkout to vmodules
        run: ln -s $(realpath mysqlite) ~/.vmodules/sqlite

      - name: Test code formatting
        run: |
          v fmt -verify ~/.vmodules/sqlite
          v fmt -w ~/.vmodules/sqlite
      - name: Run tests
        run: v test ~/.vmodules/sqlite

  sqlite-linux:
    runs-on: ubuntu-latest
    env:
      VFLAGS: -no-retry-compilation
    steps:
      - name: Checkout V
        uses: actions/checkout@v4
        with:
          repository: vlang/v
      - name: Checkout the V SQLite module
        uses: actions/checkout@v4
        with:
          path: mysqlite
      - name: Build local v
        run: make && ./v symlink
      - name: Link local checkout to vmodules
        run: ln -s $(realpath mysqlite) ~/.vmodules/sqlite

      - name: Test code formatting
        run: |
          v fmt -verify ~/.vmodules/sqlite
          v fmt -w ~/.vmodules/sqlite
      - name: Run tests
        run: v test ~/.vmodules/sqlite

  sqlite-windows:
    runs-on: windows-latest
    env:
      VFLAGS: -no-retry-compilation
    steps:
      - name: Checkout V
        uses: actions/checkout@v4
        with:
          repository: vlang/v
      - name: Checkout the V SQLite module
        uses: actions/checkout@v4
        with:
          path: ~/.vmodules/sqlite
      - name: Build local v
        run: |
          .\make.bat -gcc
          .\v.exe symlink

      - name: Test code formatting
        run: |
          v fmt -verify ~/.vmodules/sqlite
          v fmt -w ~/.vmodules/sqlite
      - name: Run tests with tcc
        run: v test ~/.vmodules/sqlite
      - name: Run tests with msvc
        run: v -cc msvc  test ~/.vmodules/sqlite
      - name: Run tests with clang
        run: v -cc clang test ~/.vmodules/sqlite
      - name: Run tests with gcc
        run: v -cc gcc   test ~/.vmodules/sqlite
